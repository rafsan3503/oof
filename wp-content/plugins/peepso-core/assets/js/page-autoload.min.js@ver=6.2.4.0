!function(e){function t(){return this.init.apply(this,arguments)}var r;PsPageAutoload=(r=e,t.prototype={init:function(e){if(!e)throw new Error("CSS prefix is not supplied!");var t=+peepsodata.loadmore_enable,t=peepso.isMobile()?1===t||2===t:1===t||3===t;return this._css_prefix=e,this._config_loadmore_enable=t,this._config_loadmore_repeat=this._config_loadmore_enable?+peepsodata.loadmore_repeat:0,r(_.bind(this.onDocumentLoaded,this)),this},onDocumentLoaded:function(){if(this._search_$ct=r(this._css_prefix).eq(0),this._search_$trigger=r(this._css_prefix+"-triggerscroll"),this._search_$loading=r(this._css_prefix+"-loading"),this._search_$nomore=r(peepsodata.activity.template_no_more).hide().insertBefore(this._search_$trigger),!this._search_$ct.length)return!1;this._search()},_search_url:"",_search_params:{},_search_loadmore_enable:null,_search:function(){this._search_toggle_autoscroll("off"),this._search_toggle_loading("show"),this._search_$ct.empty(),this._search_$nomore.hide(),this._search_params.page<=1&&(this._search_loadmore_enable=this._config_loadmore_enable,this._search_loadmore_repeat=this._config_loadmore_repeat,this._search_$loadmore&&(this._search_$loadmore.remove(),this._search_$loadmore=null)),this._search_debounced()},_search_next:function(){this._search_toggle_autoscroll("off"),this._search_toggle_loading("show"),this._search_params.page++,this._search_debounced()},_search_debounced:function(){clearTimeout(this._search_debounced_timer),this._search_debounced_timer=setTimeout(_.bind(function(){this._fetch(this._search_params).done(function(e){var t=this._search_render_html(e),s=!!t;void 0!==e.has_next&&(s=!!e.has_next),this._search_toggle_loading("hide"),t&&this._search_$ct.append(t),s?this._search_toggle_autoscroll("on"):this._search_$nomore.show()}).fail(function(e){this._search_toggle_loading("hide"),this._search_params.page<=1?this._search_$ct.html(e.join("<br>")):this._search_$nomore.show()})},this),500)},_search_render_html:function(){throw new Error("This method must be implemented by subclass!")},_search_toggle_loading:function(e){function t(e,t){(t=this._search_$loading).data("lazySrc")&&(t=this._search_$loading=r(this._css_prefix+"-loading")),"show"===e?t.show():t.hide()}"show"===e?(clearTimeout(this._search_toggle_loading_timer),t.call(this,e)):"hide"===e&&(this._search_toggle_loading_timer=setTimeout(r.proxy(function(){t.call(this,e)},this),1e3))},_search_toggle_autoscroll:function(e){var t="scroll"+this._css_prefix,s=r(peepso.observer.applyFilters("autoload_scrollable_container",window));"off"===e?s.off(t):"on"===e&&this._search_$trigger.length&&(this._search_loadmore_enable?this._search_should_load_more()?this._search_next():(this._search_$loadmore=r(peepsodata.activity.template_load_more).insertAfter(this._search_$ct),this._search_$loadmore.one("click",r.proxy(function(e){this._search_$loadmore.remove(),this._search_loadmore_repeat||(this._search_loadmore_enable=!1),this._search_next()},this))):s.off(t).on(t,r.proxy(function(){this._search_should_load_more()&&this._search_next()},this)).trigger(t))},_search_get_items:function(){return r()},_search_should_load_more:function(){var e=+peepsodata.activity_limit_below_fold,t=this._search_get_items();return this._search_loadmore_enable&&this._search_loadmore_repeat?this._search_params.page%this._search_loadmore_repeat!=0:(e=0<e?e:3,this._search_params.limit&&(e*=this._search_params.limit),!!((e=t.slice(0-e).eq(0)).length&&(this._search_loadmore_enable?e.eq(0).offset():e.get(0).getBoundingClientRect()).top<(window.innerHeight||document.documentElement.clientHeight)))},_fetch:function(e){return r.Deferred(r.proxy(function(t){e=r.extend({},e),_.isUndefined(e.limit)||(e.limit*=2),this._fetch_xhr&&this._fetch_xhr.abort(),this._fetch_xhr=peepso.getJson(this._search_url,e,r.proxy(function(e){e.success?t.resolveWith(this,[e.data]):t.rejectWith(this,[e.errors])},this))},this))}},t)}(jQuery);